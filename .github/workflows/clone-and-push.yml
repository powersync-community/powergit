name: Clone and Push

on:
  workflow_dispatch:
    inputs:
      git_url:
        description: "Git repository URL to clone"
        required: true
      org:
        description: "PowerSync org id"
        required: true
      repo:
        description: "PowerSync repo id"
        required: true
      edge_base_url:
        description: "Edge base URL (functions/v1/powersync-remote)"
        required: false

jobs:
  clone-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        run: corepack enable && corepack prepare pnpm@10.24.0 --activate

      - name: Install dependencies (workspace)
        run: pnpm install --no-frozen-lockfile

      - name: Build shared core
        run: pnpm --filter @shared/core build

      - name: Build remote-helper
        run: pnpm --filter @pkg/remote-helper build

      - name: Add remote-helper to PATH
        run: |
          echo "$PWD/node_modules/.bin" >> "$GITHUB_PATH"
          echo "$PWD/packages/remote-helper/node_modules/.bin" >> "$GITHUB_PATH"
          ln -sf "$PWD/packages/remote-helper/dist/remote-helper/src/bin.js" "$PWD/packages/remote-helper/dist/remote-helper/src/git-remote-powersync"
          chmod +x "$PWD/packages/remote-helper/dist/remote-helper/src/git-remote-powersync"
          echo "$PWD/packages/remote-helper/dist/remote-helper/src" >> "$GITHUB_PATH"

      - name: Verify remote-helper is available
        run: |
          if ! command -v git-remote-powersync >/dev/null 2>&1; then
            echo "git-remote-powersync is missing from PATH. Contents of node_modules/.bin:"
            ls -l "$PWD/node_modules/.bin" || true
            ls -l "$PWD/packages/remote-helper/node_modules/.bin" || true
            ls -l "$PWD/packages/remote-helper/dist/remote-helper/src" || true
            exit 1
          fi
          git remote -h | head -n 5

      - name: Start Powergit daemon
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || secrets.POWERSYNC_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || secrets.POWERSYNC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || secrets.POWERSYNC_SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_JWT_SECRET: ${{ secrets.SUPABASE_JWT_SECRET || secrets.POWERSYNC_SUPABASE_JWT_SECRET }}
          POWERGIT_EMAIL: ${{ secrets.POWERGIT_EMAIL }}
          POWERGIT_PASSWORD: ${{ secrets.POWERGIT_PASSWORD }}
          POWERSYNC_DAEMON_PORT: 5030
          POWERSYNC_SUPABASE_ONLY: "true"
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_ANON_KEY" ]; then
            echo "Missing Supabase configuration (SUPABASE_URL/SUPABASE_ANON_KEY)" && exit 1
          fi
          if [ -z "$POWERGIT_EMAIL" ] || [ -z "$POWERGIT_PASSWORD" ]; then
            echo "Missing Supabase login credentials (POWERGIT_EMAIL/POWERGIT_PASSWORD)" && exit 1
          fi
          nohup pnpm --filter @svc/daemon start -- --port ${POWERSYNC_DAEMON_PORT:-5030} > daemon.log 2>&1 &
          echo $! > daemon.pid
          for i in $(seq 1 30); do
            if curl -sf "http://127.0.0.1:${POWERSYNC_DAEMON_PORT:-5030}/health" >/dev/null; then
              echo "Daemon is healthy"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "Daemon did not become healthy. Logs:" && cat daemon.log && exit 1
            fi
            sleep 1
          done
          # Verify auth status
          for i in $(seq 1 20); do
            STATUS_JSON=$(curl -sf "http://127.0.0.1:${POWERSYNC_DAEMON_PORT:-5030}/auth/status" || true)
            STATUS=$(echo "$STATUS_JSON" | jq -r '.status // empty')
            echo "Auth status attempt $i: ${STATUS_JSON:-<empty>}"
            if [ "$STATUS" = "ready" ]; then
              break
            fi
            if [ "$i" -eq 20 ]; then
              echo "Daemon did not authenticate. Full log:" && cat daemon.log && exit 1
            fi
            sleep 1
          done

      - name: Clone target repo
        run: |
          git clone "${{ github.event.inputs.git_url }}" workdir
          cd workdir
          git rev-parse HEAD

      - name: Push via PowerSync edge
        env:
          POWERSYNC_EDGE_BASE_URL: ${{ github.event.inputs.edge_base_url || secrets.POWERSYNC_EDGE_BASE_URL }}
          POWERSYNC_ORG: ${{ github.event.inputs.org }}
          POWERSYNC_REPO: ${{ github.event.inputs.repo }}
          POWERSYNC_DAEMON_URL: http://127.0.0.1:5030
          POWERSYNC_DAEMON_AUTOSTART: "false"
        run: |
          cd workdir
          POWERSYNC_EDGE_BASE_URL=${POWERSYNC_DAEMON_URL:-http://127.0.0.1:5030}
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git remote add powersync "powersync::$POWERSYNC_EDGE_BASE_URL/orgs/$POWERSYNC_ORG/repos/$POWERSYNC_REPO"
          git push powersync --all
          git push powersync --tags || true
