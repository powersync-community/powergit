config:
  edition: 2

streams:
  orgs/{org_id}/repos/{repo_id}/refs:
    auto_subscribe: false
    query: |
      SELECT id, org_id, repo_id, name, target_sha, updated_at
      FROM refs
      WHERE subscription.parameter('org_id') IS NOT NULL
        AND subscription.parameter('repo_id') IS NOT NULL
        AND org_id = subscription.parameter('org_id')
        AND repo_id = subscription.parameter('repo_id')
        AND (
          subscription.parameter('org_id') IN (
            SELECT org_id
            FROM org_members
            WHERE user_id::text = auth.user_id()
          )
          OR subscription.parameter('repo_id') IN (
            SELECT repo_id
            FROM repositories
            WHERE org_id = subscription.parameter('org_id')
              AND visibility = 'public'
          )
        )

  orgs/{org_id}/repos/{repo_id}/commits:
    auto_subscribe: false
    query: |
      SELECT id, org_id, repo_id, sha, author_name, author_email, authored_at, message, tree_sha
      FROM commits
      WHERE subscription.parameter('org_id') IS NOT NULL
        AND subscription.parameter('repo_id') IS NOT NULL
        AND org_id = subscription.parameter('org_id')
        AND repo_id = subscription.parameter('repo_id')
        AND (
          subscription.parameter('org_id') IN (
            SELECT org_id
            FROM org_members
            WHERE user_id::text = auth.user_id()
          )
          OR subscription.parameter('repo_id') IN (
            SELECT repo_id
            FROM repositories
            WHERE org_id = subscription.parameter('org_id')
              AND visibility = 'public'
          )
        )

  orgs/{org_id}/repos/{repo_id}/file_changes:
    auto_subscribe: false
    query: |
      SELECT id, org_id, repo_id, commit_sha, path, additions, deletions
      FROM file_changes
      WHERE subscription.parameter('org_id') IS NOT NULL
        AND subscription.parameter('repo_id') IS NOT NULL
        AND org_id = subscription.parameter('org_id')
        AND repo_id = subscription.parameter('repo_id')
        AND (
          subscription.parameter('org_id') IN (
            SELECT org_id
            FROM org_members
            WHERE user_id::text = auth.user_id()
          )
          OR subscription.parameter('repo_id') IN (
            SELECT repo_id
            FROM repositories
            WHERE org_id = subscription.parameter('org_id')
              AND visibility = 'public'
          )
        )

  orgs/{org_id}/repos/{repo_id}/objects:
    auto_subscribe: false
    query: |
      SELECT id, org_id, repo_id, pack_oid, storage_key, size_bytes, created_at
      FROM objects
      WHERE subscription.parameter('org_id') IS NOT NULL
        AND subscription.parameter('repo_id') IS NOT NULL
        AND org_id = subscription.parameter('org_id')
        AND repo_id = subscription.parameter('repo_id')
        AND (
          subscription.parameter('org_id') IN (
            SELECT org_id
            FROM org_members
            WHERE user_id::text = auth.user_id()
          )
          OR subscription.parameter('repo_id') IN (
            SELECT repo_id
            FROM repositories
            WHERE org_id = subscription.parameter('org_id')
              AND visibility = 'public'
          )
        )

  repositories:
    auto_subscribe: true
    query: |
      SELECT id, org_id, repo_id, repo_url, created_at, updated_at, default_branch, last_status, last_import_job_id
      FROM repositories
      WHERE visibility = 'public'
         OR org_id IN (
           SELECT org_id
           FROM org_members
           WHERE user_id::text = auth.user_id()
         )

  import_jobs:
    auto_subscribe: true
    query: |
      SELECT id, org_id, repo_id, repo_url, status, created_at, updated_at, branch, default_branch, error, workflow_url, source
      FROM import_jobs
      WHERE requested_by::text = auth.user_id()
         OR org_id IN (
           SELECT org_id
           FROM org_members
           WHERE user_id::text = auth.user_id()
         )
